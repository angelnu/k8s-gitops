---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mealie
spec:
  interval: 5m
  chart:
    spec:
      chart: app-template
      version: 4.5.0
      interval: 15m
      sourceRef:
        kind: HelmRepository
        name: bjw-s-helm-charts
        namespace: flux-system
  # See https://github.com/bjw-s/helm-charts/blob/main/charts/library/common/values.yaml
  values:
    controllers:
      main:
        containers:
          app:
            image:
              repository: docker.io/hkotel/mealie
              tag: frontend-v1.0.0beta-4
            env:
              TZ: "Europe/Berlin"
              # -- Set the application database type
              DB_TYPE: sqlite
          api:
            image:
              repository: ghcr.io/mealie-recipes/mealie
              tag: v3.8.0@sha256:8cb354ce7b9e73304c0f3dedf13b7fe8ffe2f25775c9bbe79b5c446ef0334fd6
            env:
              TZ: "Europe/Berlin"
              API_PORT: &api_port "9000"
        
    persistence:
      api-data:
        enabled: true
        existingClaim: mealie-pvc
        advancedMounts:
          main:
            api:
            - path: /app/data

    service:
      main:
        controller: main
        ports:
          http:
            port: 3000
          api:
            port: *api_port

    ingress:
      main:
        enabled: true
        annotations:
          hajimari.io/enable: "true"
          hajimari.io/icon: game-icons:meal
          hajimari.io/info: Meal Recipes
          hajimari.io/group: documents
          nginx.ingress.kubernetes.io/configuration-snippet: |
            auth_request_set $required_groups 'casa_editors';
        hosts:
        - host: mealie.pub.${CLUSTER_DOMAIN}
          paths: &paths
          - path: /
            pathType: Prefix
            service:
              identifier: main
              port: http
        - host: mealie.home.${CLUSTER_DOMAIN}
          paths: *paths
