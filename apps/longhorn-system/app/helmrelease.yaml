---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app longhorn
spec:
  chart:
    spec:
      chart: longhorn
      version: 1.11.0
      interval: 60m
      sourceRef:
        kind: HelmRepository
        name: longhorn
        namespace: longhorn-system
  interval: 30m
  timeout: 20m
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    openshift:
      enabled: true
      ui:
        route: "longhorn-ui"
        port: 443
        proxy: 8443
    image:
      longhorn:
        engine:
          repository: &defaultRegistry docker.io
        manager:
          repository: *defaultRegistry
        ui:
          repository: *defaultRegistry
        instanceManager:
          repository: *defaultRegistry
        shareManager:
          repository: *defaultRegistry
        backingImageManager:
          repository: *defaultRegistry
        supportBundleKit:
          repository: *defaultRegistry
      csi:
        attacher:
          repository: *defaultRegistry
        provisioner:
          repository: *defaultRegistry
        nodeDriverRegistrar:
          repository: *defaultRegistry
        resizer:
          repository: *defaultRegistry
        snapshotter:
          repository: *defaultRegistry
        livenessProbe:
          repository: *defaultRegistry
      openshift:
        oauthProxy:
          repository: quay.io
          tag: 4.20 # renovate: depName=quay.io/openshift/origin-oauth-proxy datasource=docker
      defaultSettings:
        # Recommended for databases with app-level redundancy:
        # This allows the drain to proceed even if the volume is the last replica.
        nodeDrainPolicy: allow-if-replica-is-stopped
      defaultBackupStore:
        backupTarget: cifs://nas.home.${HOME_DOMAIN}/NetBackup/longhorn/${CLUSTER_NAME}
        backupTargetCredentialSecret: cifs-secret
