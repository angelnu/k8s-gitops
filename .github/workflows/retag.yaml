name: Retag for production 
on:
    schedule:
        # Saturday at 12:00 UTC
        - cron: "0 12 * * 6"
    workflow_dispatch: # Allows manual testing

jobs:
    retag:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Required to push tags back

            - name: Wait for tests to complete
              id: wait_for_tests
              env:
                GH_TOKEN: ${{ github.token }}
              run: |
                # Configuration
                MAX_ATTEMPTS=12 # 12 attempts * 5 mins = 60 minutes
                SLEEP_TIME=300 # 5 minutes
                
                for ((i=1; i<=MAX_ATTEMPTS; i++)); do
                    # Get the combined status (success, pending, failure)
                    # This covers all GitHub Actions and external status checks
                    STATUS=$(gh api repos/${{ github.repository }}/commits/${{ github.sha }}/status --jq '.state')
                    
                    echo "Attempt $i: Current commit status is '$STATUS'"
                    
                    if [ "$STATUS" == "success" ]; then
                    echo "Tests passed!"
                    exit 0
                    elif [ "$STATUS" == "failure" ] || [ "$STATUS" == "error" ]; then
                    echo "Tests failed. Cannot retag."
                    exit 1
                    fi
                    
                    echo "Tests still in progress (pending)... sleeping for 5 minutes."
                    sleep $SLEEP_TIME
                done

                echo "Timed out waiting for tests to complete."
                exit 1

            - name: Update Tag
              run: |
                  git config user.name "angelnu-bot[bot]"
                  git config user.email "mailto:115925344+angelnu-bot[bot]@users.noreply.github.com"

                  TAG_NAME="production"

                  git tag -f $TAG_NAME
                  git push origin $TAG_NAME --force
