name: Retag for production 
on:
  schedule:
    - cron: '0 12 * * 6'
  workflow_dispatch:

jobs:
  retag: # This name is used in the filter below
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Wait for other tests to complete
        id: wait_for_tests
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          MAX_ATTEMPTS=12
          SLEEP_TIME=300
          
          for ((i=1; i<=MAX_ATTEMPTS; i++)); do
            # Fetch all check runs EXCEPT for this specific 'retag' job
            # We look for any conclusion that isn't 'success' or 'skipped'
            NON_SUCCESS_CHECKS=$(gh api repos/${{ github.repository }}/commits/${{ github.sha }}/check-runs \
              --jq '.check_runs | map(select(.name != "retag" and .conclusion != "success" and .conclusion != "skipped")) | length')

            # Also check if there are any checks still 'in_progress' or 'queued' (again, excluding self)
            PENDING_CHECKS=$(gh api repos/${{ github.repository }}/commits/${{ github.sha }}/check-runs \
              --jq '.check_runs | map(select(.name != "retag" and .status != "completed")) | length')

            echo "Attempt $i: Found $PENDING_CHECKS pending and $NON_SUCCESS_CHECKS non-success checks (excluding self)."

            if [ "$PENDING_CHECKS" -eq 0 ]; then
              if [ "$NON_SUCCESS_CHECKS" -eq 0 ]; then
                echo "All other tests passed!"
                exit 0
              else
                echo "Other tests finished but some failed. Aborting."
                exit 1
              fi
            fi
            
            echo "Other tests still running... sleeping 5m."
            sleep $SLEEP_TIME
          done

          echo "Timeout reached."
          exit 1

      - name: Update Tag
        run: |
            git config user.name "angelnu-bot[bot]"
            git config user.email "mailto:115925344+angelnu-bot[bot]@users.noreply.github.com"

            TAG_NAME="production"

            git tag -f $TAG_NAME
            git push origin $TAG_NAME --force
